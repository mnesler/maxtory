// Tag Cards Pipeline
//
// Tags all untagged cards for a given set using the LLM tagging script.
// One pipeline run = one set. Triggered manually via POST /api/runs.
//
// The set code is substituted into the toolCommand before the run starts.
// To run for set 'dsk', replace SET_CODE with 'dsk' in the toolCommand
// before submitting, or set it as a graph attribute and use $set_code.
//
// Loop logic:
//   tag_batch runs tag_set.ts which outputs {"outcome":"more"} or {"outcome":"done"}
//   check_done routes back to tag_batch if "more", exits if "done"
//
// Checkpointing:
//   The pipeline engine saves a checkpoint after every node execution.
//   tag_set.ts only queries cards WHERE oracle_id NOT IN card_tags, so
//   re-running a partially-complete set safely skips already-tagged cards.

digraph tag_set {
  label="Tag cards by set"
  goal="Tag all untagged commander-legal cards for the specified set"

  start      [shape=Mdiamond, label="Start"]
  tag_batch  [shape=parallelogram,
              label="Tag batch",
              toolCommand="node mtg/dist/tagger/tag_set.js --set=SET_CODE --batch=20"]
  check_done [shape=diamond, label="More cards?"]
  exit       [shape=Msquare, label="Done"]

  start      -> tag_batch
  tag_batch  -> check_done
  check_done -> tag_batch [label="more", condition="tool.output contains more"]
  check_done -> exit      [label="done", condition="tool.output contains done"]
}
